<style>
  .property-container {
    width: 100%;
    padding: 8px 0;
  }
  .property-inner {
    display: flex;
    justify-content: space-between;
    padding: 8px;
  }
  div.property-list {
    border: solid 1px #aaa;
    margin-bottom: 8px;
  }
  textarea.property-description {
    width: 90%;
    height: 8rem;
    resize: none;
    margin: 0 5%;
  }
  div.toggle-button {
    border: solid 1px #aaa;
    background-color: #ccc;
    cursor: pointer;
    padding: 8px 8px;
  }
  #node-id {
    display: none;
  }
  #node-name {
    display: none;
  }
  #node-property-name {
    width: 40%;
    word-break: break-all;
    padding: 0 5px;
  }
  #node-property-value {
    width: 50%;
    word-break: break-all;
    padding: 0 5px;
  }
  .property-checkbox {
    width: 10%;
    max-height: 15px;
    max-width: 10%;
  }
  #checkbox-description {
    padding-left: 8px;
    margin-bottom: 15px;
    color: #737373;
  }
</style>

<script type="text/javascript">
  RED.nodes.registerType("config", {
    category: "GBL-SASM-Alert",
    color: "#E0C67E",
    defaults: {
      name: { value: "" },
      properties: { value: [] }
    },
    inputs: 1,
    outputs: 1,
    label: function () {
      return this.name || "module config";
    },
    oneditprepare: function () {
      $(document).ready(function () {
        // initially, hide property list
        $(".property-list").hide();

        // click event handler for toggle-button
        $("div.toggle-button").click(function () {
          $(this.nextSibling).toggle();
        });

        // input window appear when click the checkbox
        $(".property-checkbox").change(function () {
          if ($(this).is(":checked")) {
            $(this.parentNode.parentNode).append(
              $("<textarea>")
                .attr("class", "property-description")
                .attr(
                  "placeholder",
                  "Please write a description for the property."
                )
            );
          } else {
            $(this.parentNode.parentNode).children()[1].remove();
          }
        });
      });

      // get all downstream nodes after config node without module-out node
      const moduleFlows = RED.nodes
        .getAllDownstreamNodes(this)
        .filter(
          elem => elem.type !== "module_out" && elem.type !== "submodule"
        );
      // filter required info from all node's property
      const moduleProperties = moduleFlows.map(node => {
        return {
          nodeId: node.id,
          nodeName: node.name || node.type,
          properties: Object.entries(node._config).filter(
            config => config[0] !== "x" && config[0] !== "y"
          )
        };
      });
      const $nodeCheckboxContainer = $("#node-checkbox-container");
      if (moduleProperties) {
        const $nodesTitle = $("<h3>").text("Nodes in current module");
        $nodeCheckboxContainer.prepend($nodesTitle);
      }

      const nodeCheckboxList = $("#node-checkbox-list");
      moduleProperties.forEach(element => {
        // add the node name to toggle properties.
        const $node = $("<div>").attr("class", "form-row");
        const $nodeName = $("<div>")
          .attr("class", "toggle-button")
          .html(element.nodeName + " &#9660;");
        const $propertyList = $("<div>").attr("class", "property-list");
        const $propertiesTitle = $("<h3>")
          .text(`Properties of ${element.nodeName} node`)
          .css("padding-left", "8px");
        const $description = $("<div>")
          .attr("id", "checkbox-description")
          .text(
            `Select properties of ${element.nodeName} node that need to be modified.`
          );
        const $propertyInner = $("<div>").attr("class", "property-inner");
        const $checkbox = $("<span>").attr("class", "property-checkbox");
        const $nodeProperty = $("<span>")
          .attr("id", "node-property-name")
          .text("Property Name")
          .css("font-weight", "800");
        const $nodeValue = $("<span>")
          .attr("id", "node-property-value")
          .text("Given Value")
          .css("font-weight", "800");
        const $container = $("<div>")
          .css("border", "solid 1px #C9C9C9")
          .css("margin", "5px");
        $propertyInner
          .append($checkbox)
          .append($nodeProperty)
          .append($nodeValue);
        $container.append($propertyInner);
        $propertyList
          .append($propertiesTitle)
          .append($description)
          .append($container);
        $node.append($nodeName).append($propertyList);
        nodeCheckboxList.append($node);

        element.properties.forEach((property, index) => {
          // add checkbox of each node's properties
          const $propertyContainer = $("<div>").attr(
            "class",
            "property-container"
          );
          if (index % 2 == 0) {
            $propertyContainer.css("background-color", "#F6F9FF");
          }
          const $propertyInner = $("<div>").attr("class", "property-inner");

          const $nodeId = $("<span>")
            .attr("id", "node-id")
            .text(element.nodeId);
          const $nodeName = $("<span>")
            .attr("id", "node-name")
            .text(element.nodeName);
          const $checkBox = $("<input>")
            .attr("type", "checkbox")
            .attr("class", "property-checkbox");
          const $nodeProperty = $("<span>")
            .attr("id", "node-property-name")
            .text(property[0]);
          const $nodeValue = $("<span>")
            .attr("id", "node-property-value")
            .text(property[1]);

          $propertyInner
            .append($nodeId)
            .append($nodeName)
            .append($checkBox)
            .append($nodeProperty)
            .append($nodeValue);

          $propertyContainer.append($propertyInner);
          $container.append($propertyContainer);

          // If there are existing properties saved
          // check the checkbox and fill in the description in the textarea.
          const targetProperty = this.properties.find(
            propertyObject =>
              propertyObject.nodeId === element.nodeId &&
              propertyObject.propertyName === property[0]
          );
          if (targetProperty) {
            $checkBox.prop("checked", true);
            const $textarea = $("<textarea>")
              .attr("class", "property-description")
              .attr(
                "placeholder",
                "Please write a description for the property."
              )
              .val(targetProperty.description);
            $propertyContainer.append($textarea);
          }
        });
      });

      // initialize properties
      this.properties = [];
    },
    oneditsave: function () {
      const node = this;
      // save properties
      $(".property-checkbox").each(function () {
        if ($(this).is(":checked")) {
          const nodeId = $(this).parent().children()[0].innerText;
          const nodeName = $(this).parent().children()[1].innerText;
          const propertyName = $(this).parent().children()[3].innerText;
          const description = $(this).parent().parent().children()[1].value;
          node.properties.push({
            nodeId: nodeId,
            nodeName: nodeName,
            propertyName: propertyName,
            description: description
          });
        }
      });
    },
    oneditcancle: function () {}
  });
</script>

<script type="text/html" data-template-name="config">
  <div class="form-row">
    <label for="node-input-name"><i class="icon-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name" />
  </div>
  <!--nodes in module-->
  <div id="node-checkbox-container">
    <div id="node-checkbox-list"></div>
  </div>
</script>

<script type="text/html" data-help-name="config">
  <div>
    <p>config descrption text</p>
  </div>
</script>
