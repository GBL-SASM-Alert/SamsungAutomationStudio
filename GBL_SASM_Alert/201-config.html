<style>
  .property-container {
    width: 90%;
    margin: 15px 0;
  }
  .property-inner {
    display: flex;
    justify-content: space-between;
  }
</style>

<script type="text/javascript">
  RED.nodes.registerType("config", {
    category: "GBL-SASM-Alert",
    color: "#E0C67E",
    defaults: {
      name: { value: "" },
      properties: { value: [] }
    },
    inputs: 1,
    outputs: 1,
    label: function () {
      return this.name || "module config";
    },
    oneditprepare: function () {
      $(document).ready(function () {
        // initially, hide property list
        $(".property-list").hide();

        // click event handler for toggle-button
        $("button.toggle-button").click(function () {
          $(this.nextSibling).toggle();
        });

        // input window appear when click the checkbox
        $(".property-checkbox").change(function () {
          if ($(this).is(":checked")) {
            $(this.parentNode.parentNode).append(
              $("<textarea>")
                .attr("class", "property-description")
                .attr(
                  "placeholder",
                  "Please write a description for the property."
                )
                .css("width", "100%")
                .css("height", "8rem")
                .css("resize", "none")
            );
          } else {
            $(this.parentNode.parentNode).children()[1].remove();
          }
        });
      });

      // get all downstream nodes after config node without module-out node
      const moduleFlows = RED.nodes.getAllDownstreamNodes(this).slice(0, -1);

      //
      const moduleProperties = moduleFlows.map(node => {
        return {
          nodeName: node.name || node.type,
          properties: Object.keys(node._config).filter(
            config => config !== "x" && config !== "y"
          )
        };
      });

      const nodeCheckboxList = $("#node-checkbox-list");
      moduleProperties.forEach(element => {
        const $node = $("<div>").attr("class", "form-row");
        const $nodeName = $("<label>").text(element.nodeName);
        const $toggleButton = $("<button>")
          .attr("class", "toggle-button")
          .html("&#9662;");
        const $propertyList = $("<div>").attr("class", "property-list");
        $node.append($nodeName).append($toggleButton).append($propertyList);

        nodeCheckboxList.append($node);

        element.properties.forEach(property => {
          const html = `\
          <div class='property-container'>\
            <div class='property-inner'> \
              <span>${element.nodeName}.${property}</span> \
              <input type='checkbox' class='property-checkbox'/> \
            </div>\
          </div>`;
          $propertyList.append(html);
        });
      });
    },
    oneditsave: function () {
      const node = this;
      $(".property-checkbox").each(function () {
        if ($(this).is(":checked")) {
          const nodeProperty = $(this)
            .parent()
            .children()[0]
            .innerText.split(".");
          const description = $(this).parent().parent().children()[1].value;
          node.properties.push({
            nodeName: nodeProperty[0],
            property: nodeProperty[1],
            description: description
          });
        }
      });

      console.log(node.properties);
    },
    oneditcancle: function () {
      console.log("CANCEL");
    }
  });
</script>

<script type="text/html" data-template-name="config">
  <div class="form-row">
    <label for="node-input-name"><i class="icon-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name" />
  </div>
  <!--nodes in module-->
  <div>
    <div id="node-checkbox-list"></div>
  </div>
</script>

<script type="text/html" data-help-name="config">
  <div>
    <p>config descrption text</p>
  </div>
</script>
