<script type="text/javascript">
  RED.nodes.registerType("moduleflows", {
    category: "GBL-SASM-Alert",
    color: "#FFA07A",
    defaults: {
      name: { value: "module" },
      moduleId: { value: "" },
      submoduleId: { value: "" }
    },
    inputs: 1,
    outputs: 1,
    icon: function () {
      return "moduleflows_white.png";
    },
    label: function () {
      //change module name => change node name
      return this.name || "moduleflows";
    },
    //open editor box
    oneditprepare: function () {
      //###1. Dynamic module select
      //select element
      let moduleSelectElem = $("#module-select");

      //1.1 init module options
      let currentTab = RED.workspaces.active();
      RED.nodes.eachNode(function (node) {
        if (node.type === "module_in" && node.z == currentTab) {
          let option = $("<option></option>");
          option.text(node.name);
          option.val(node.id);
          moduleSelectElem.append(option);
        }
      });
      //1.2 default module option
      if (this.moduleId) {
        moduleSelectElem.val(this.moduleId).prop("selected", true);
      } else {
        $("#module-select option:eq(0)").prop("selected", true);
        this.moduleId = $("#module-select").val();
      }

      //###2. init submodule select
      let submoduleSelectElem = $("#submodule-select");

      let initSubmoduleOptions = function (links) {
        links.forEach(link => {
          if (link.target.type === "submodule") {
            let option = $("<option></option>");
            option.text(link.target.name);
            option.val(link.target.id);
            submoduleSelectElem.append(option);
          }
        });
      };

      //2.2 default submodule option
      if (this.moduleId) {
        let links = RED.nodes.getNodeLinks(this.moduleId);
        initSubmoduleOptions(links);
        if (this.submoduleId) {
          submoduleSelectElem.val(this.submoduleId).prop("selected", true);
        } else {
          $("#submodule-select option:eq(0)").prop("selected", true);
        }
      }

      //###3. Event
      let node = this;
      $("#module-select").on("change", function () {
        let changedModuleId = $("#module-select").val();

        //###3.1 Dynamic submodule select
        //clear options
        $("select#submodule-select option").remove();
        let links = RED.nodes.getNodeLinks(changedModuleId);
        initSubmoduleOptions(links);
      });
    },
    oneditsave: function () {
      var node = this;
      //module save
      node.moduleId = $("#module-select").val();

      //submodule save
      node.submoduleId = $("#submodule-select").val();
    },
    oneditcancle: function () {}
  });
</script>

<script type="text/javascript">
  RED.nodes.registerType("module_in", {
    category: "GBL-SASM-Alert",
    color: "#FA8072",
    defaults: {
      info: { value: "Describe your module action here." },
      name: { value: "module in" }
    },
    inputs: 0,
    outputs: 1,
    icon: function () {
      return "moduleflows_white.png";
    },
    label: function () {
      return this.name || "module in";
    },
    //open editor box
    oneditprepare: function () {
      this.editor = RED.editor.createEditor({
        id: "node-description-editor",
        mode: "ace/mode/markdown",
        value: $("#node-input-info").val()
      });
    },
    oneditsave: function () {
      var node = this;
      $("#node-input-info").val(this.editor.getValue());
      this.editor.destroy();
      delete node.editor;
    },
    oneditcancle: function () {
      this.editor.destroy();
      delete this.editor;
    }
  });
</script>

<script type="text/javascript">
  RED.nodes.registerType("module_out", {
    category: "GBL-SASM-Alert",
    color: "#1E90FF",
    defaults: {
      name: { value: "module out" }
    },
    inputs: 1,
    outputs: 0,
    icon: function () {
      return "moduleflows_white.png";
    },
    label: function () {
      return this.name || "module out";
    }
  });
</script>

<script type="text/html" data-template-name="moduleflows">
  <div class="form-row">
    <label for="node-input-name"><i class="icon-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name" />
  </div>
  <!--module-->
  <div class="form-row">
    <label for="node-input-scope"
      ><i class="fa fa-random"></i> <span>Module</span></label
    >
    <select id="module-select"></select>
  </div>
  <!--submodule-->
  <div class="form-row">
    <label for="node-input-scope"
      ><i class="fa fa-random"></i> <span>SubModule</span></label
    >
    <select id="submodule-select"></select>
  </div>
</script>

<script type="text/html" data-template-name="module_in">
  <div class="form-row" id="actionflows-name">
    <label for="node-input-name"><i class="icon-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name" />
  </div>

  <!-- module in : module description -->
  <!-- markdown options -->
  <div class="form-row" style="margin-bottom: 0px;">
    <label for="node-input-info">Description</label>
    <a
      href="https://guides.github.com/features/mastering-markdown/"
      target="_blank"
      style="font-size: 0.8em; float: right;"
      >markdown</a
    >
    <input type="hidden" id="node-input-info" autofocus="autofocus" />
  </div>
  <!-- editor box -->
  <div class="form-row node-text-editor-row">
    <div
      style="height: 250px; min-height:150px;"
      class="node-text-editor"
      id="node-description-editor"
    ></div>
  </div>
</script>

<script type="text/html" data-template-name="module_out">
  <div class="form-row" id="actionflows-name">
    <label for="node-input-name"><i class="icon-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name" />
  </div>
</script>

<script type="text/html" data-help-name="moduleflows">
  <div>
    <p>module descrption text</p>
  </div>
</script>
<script type="text/html" data-help-name="module_in">
  <div>
    <p>module_in descrption text</p>
  </div>
</script>
<script type="text/html" data-help-name="module_out">
  <div>
    <p>module_out descrption text</p>
  </div>
</script>
