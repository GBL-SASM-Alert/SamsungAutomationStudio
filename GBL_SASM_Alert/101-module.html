<style>
  .description-box {
    width: 100%;
    margin: 0px 0px 12px 0px;
    padding: 5px;
    position: relative;
    border-left: 5px solid #333333;
  }
  .property-description-box {
    width: 100%;
    margin: 12px 0px 12px 0px;
    padding: 5px;
    position: relative;
    border-left: 5px solid #333333;
  }
  .error-box {
    font-size: 8pt;
    color: red;
  }
  #actionflows-name {
    display: flex;
  }
  #node-name-input-box {
    display: block;
    width: 100%;
  }
</style>
<script type="text/javascript">
  RED.nodes.registerType("moduleflows", {
    category: "GBL-SASM-Alert",
    color: "#FFA07A",
    defaults: {
      name: { value: "module" },
      moduleId: { value: "" },
      submoduleId: { value: "" },
      properties: { value: [] }
    },
    inputs: 1,
    outputs: 1,
    icon: function () {
      return "moduleflows_white.png";
    },
    label: function () {
      //change module name => change node name
      return this.name || "moduleflows";
    },
    //open editor box
    oneditprepare: function () {
      //###0. init value
      $("#moduleflows-node-name").val(this.name);

      //###1. Dynamic module select
      //select element
      let moduleSelectElem = $("#module-select");
      let descriptionMap = new Map(); //node-id : description

      //1.1 init module options
      let currentTab = RED.workspaces.active();
      RED.nodes.eachNode(function (node) {
        if (node.type === "GBL_module_in" && node.z == currentTab) {
          let option = `<option value="${node.id}" title="${node.info}">${node.name}</option>`;
          moduleSelectElem.append(option);

          //mapping description
          descriptionMap.set(node.id, node.info);
        }
      });

      //1.2 default module option
      if (this.moduleId) {
        moduleSelectElem.val(this.moduleId).prop("selected", true);
      } else {
        $("#module-select option:eq(0)").prop("selected", true);
        this.moduleId = $("#module-select").val();
      }
      $("#module-description").text(descriptionMap.get(this.moduleId));

      //###2. init submodule
      let submoduleElem = $("#submodule");

      let initSubmodule = function () {
        let newDiv = $("<div>").addClass("form-row");
        let label = $("<label>").attr("for", "node-input-scope");
        let icon = $("<i>").addClass("fa fa-random");
        let span = $("<span>").text("SubModule");

        label.append(icon);
        label.append(span);
        newDiv.append(label);

        let select = $("<select>").attr("id", "submodule-select");
        let descriptionBox = $("<div>")
          .attr("id", "submodule-description")
          .addClass("description-box");

        newDiv.append(select);
        submoduleElem.append(newDiv);
        submoduleElem.append(descriptionBox);
      };

      let initSubmoduleOptions = function (node) {
        let submoduleSelectElem = $("#submodule-select");
        let option = `<option value="${node.id}" title="${node.info}">${node.name}</option>`;
        submoduleSelectElem.append(option);

        //mapping description
        descriptionMap.set(node.id, node.info);
      };

      //2.2 default submodule option
      if (this.moduleId) {
        let isSubmoduleExist = false;

        RED.nodes
          .getAllDownstreamNodes(RED.nodes.node(this.moduleId))
          .forEach(node => {
            if (node.type === "submodule") {
              isSubmoduleExist = true;
            }
          });

        if (isSubmoduleExist) initSubmodule();

        RED.nodes
          .getAllDownstreamNodes(RED.nodes.node(this.moduleId))
          .forEach(node => {
            if (node.type === "submodule") {
              initSubmoduleOptions(node);
            }
          });

        let submoduleSelectElem = $("#submodule-select");

        if (this.submoduleId) {
          submoduleSelectElem.val(this.submoduleId).prop("selected", true);
        } else {
          $("#submodule-select option:eq(0)").prop("selected", true);
        }
        $("#submodule-description").text(descriptionMap.get(this.submoduleId));
      }

      //###2.3 init module properties inputs
      let propertySelectElem = $("#property-input");

      let initPropertyInputs = function (links) {
        links.forEach(link => {
          if (link.target.type === "config") {
            link.target.properties.forEach(property => {
              let nodeOfModule = RED.nodes.node(property.nodeId);
              if (nodeOfModule.id === property.nodeId) {
                let newDiv = $("<div>");
                newDiv.addClass("form-row");

                let label = $("<label>").attr("for", "node-input-scope");
                label.append('<i class="fa fa-gear"> </i>');
                label.append("<span> " + property.propertyName + "</span>");

                let input = $("<input>")
                  .val(
                    typeof nodeOfModule[property.propertyName] === "object"
                      ? JSON.stringify(nodeOfModule[property.propertyName])
                      : nodeOfModule[property.propertyName]
                  )
                  .attr("type", "text")
                  .attr("name", property.propertyName);

                let descriptionDev = $(
                  '<div id="description-box" class="property-description-box">'
                ).text(
                  property.description
                    ? property.description
                    : "property lacks a description"
                );
                newDiv.append(label, input, descriptionDev);
                propertySelectElem.append(newDiv);
              }
            });
          }
        });
      };

      //2.4 default property inputs
      if (this.moduleId) {
        let links = RED.nodes.getNodeLinks(this.moduleId);
        initPropertyInputs(links);
      }

      //###3. Event
      let node = this;
      $("#module-select").on("change", function () {
        let changedModuleId = $("#module-select").val();

        //3.1 module description
        $("#module-description").text(descriptionMap.get(changedModuleId));

        //3.2 Dynamic submodule select
        //clear submodule
        $("#submodule div").remove();
        //get new link and init options
        let isSubmoduleExist = false;

        RED.nodes
          .getAllDownstreamNodes(RED.nodes.node(changedModuleId))
          .forEach(node => {
            if (node.type === "submodule") {
              isSubmoduleExist = true;
            }
          });

        if (isSubmoduleExist) initSubmodule();

        RED.nodes
          .getAllDownstreamNodes(RED.nodes.node(changedModuleId))
          .forEach(node => {
            if (node.type === "submodule") {
              initSubmoduleOptions(node);
            }
          });
        //default first element selected
        $("#submodule-select option:eq(0)").prop("selected", true);
        $("#submodule-description").text(
          descriptionMap.get($("#submodule-select option:eq(0)").val())
        );

        //3.3 Dynamic property inputs
        $("div#property-input label").remove();
        $("div#property-input input").remove();
        $("div#property-input div").remove();
        $("div#property-input br").remove();
        //get new link and init options
        let links = RED.nodes.getNodeLinks(changedModuleId);
        initPropertyInputs(links);
      });

      $("#submodule").on("change", function () {
        let changedSubmoduleId = $("#submodule-select").val();
        $("#submodule-description").text(
          descriptionMap.get(changedSubmoduleId)
        );
        console.log(descriptionMap.get(changedSubmoduleId));
      });
    },
    oneditsave: function () {
      var node = this;
      //name save
      node.name = $("#moduleflows-node-name").val();

      //module save
      node.moduleId = $("#module-select").val();

      //submodule save
      node.submoduleId = $("#submodule-select").val();

      //properties save and customize other module nodes
      if (node.moduleId) {
        let links = RED.nodes.getNodeLinks(node.moduleId);
        links.forEach(link => {
          if (link.target.type === "config") {
            node.properties = link.target.properties;
          }
        });

        let inputs = $("#property-input input");
        node.properties.forEach(property => {
          let nodeOfModule = RED.nodes.node(property.nodeId);
          inputs.each(function () {
            let inputName = $(this).attr("name");
            let inputValue = $(this).val();

            if (property.propertyName === inputName) {
              nodeOfModule[inputName] =
                typeof nodeOfModule[inputName] === "object"
                  ? JSON.parse(inputValue)
                  : inputValue;
              RED.nodes.add(nodeOfModule);

              property[inputName] = inputValue;
            }
          });
        });
      }

      console.log(node);
    },
    oneditcancle: function () {}
  });
</script>

<script type="text/javascript">
  RED.nodes.registerType("GBL_module_in", {
    category: "GBL-SASM-Alert",
    color: "#FA8072",
    defaults: {
      info: { value: "Describe your module action here." },
      name: {
        value: "module in",
        required: true
      },
      errorMsg: { value: "" },
      duplicatedError: { value: false }
    },
    inputs: 0,
    outputs: 1,
    icon: function () {
      return "moduleflows_white.png";
    },
    label: function () {
      return this.name || "module in";
    },
    //open editor box
    oneditprepare: function () {
      //###0. init value
      $("#module-in-node-name").val(this.name);

      this.editor = RED.editor.createEditor({
        id: "node-description-editor",
        mode: "ace/mode/markdown",
        value: $("#node-input-info").val()
      });

      //### 1. Duplicated module name
      //1.1 all module in node in current tab except this node
      let currentTab = RED.workspaces.active();
      let allModuleNames = new Set();
      RED.nodes.eachNode(node => {
        if (
          node.type === "GBL_module_in" &&
          node.z == currentTab &&
          node.id != this.id //except this node
        ) {
          allModuleNames.add(node.name);
        }
      });

      //1.2 Event: change name
      let displayMsg = (msg, color) => {
        $("#module-in-node-error-box").text(msg);
        $("#module-in-node-error-box").css("color", color);
      };

      let checkDuplicatedname = name => {
        //check duplicated name
        if (!allModuleNames.has(name)) {
          //ok
          this.errorMsg = "Available name";
          this.duplicatedError = false;
          displayMsg(this.errorMsg, "green");
        } else {
          //error msg
          this.errorMsg = "Duplicated name";
          this.duplicatedError = true;
          displayMsg(this.errorMsg, "red");
        }
      };
      checkDuplicatedname(this.name);

      let thiz = this;
      $("#module-in-node-name").on("input", event => {
        let newName = event.target.value;

        //1.1 all module in node in current tab except this node
        let currentTab = RED.workspaces.active();
        RED.nodes.eachNode(node => {
          if (
            node.type === "GBL_module_in" &&
            node.z == currentTab &&
            node.id != thiz.id //except this node
          ) {
            if (node.name === newName) {
              //same name => change node duplicatedError
              node.errorMsg = "Duplicated name";
              node.duplicatedError = true;
              // console.log(node.errorMsg);
              // console.log(node.duplicatedError);

              thiz.errorMsg = "Duplicated name";
              thiz.duplicatedError = true;
              displayMsg(thiz.errorMsg, "red");
            } else {
              node.errorMsg = "Available name";
              node.duplicatedError = false;
              // console.log(node.errorMsg);
              // console.log(node.duplicatedError);

              //ok
              thiz.errorMsg = "Available name";
              thiz.duplicatedError = false;
              displayMsg(thiz.errorMsg, "green");
            }
          }
        });

        checkDuplicatedname(newName);
      });
    },
    oneditsave: function () {
      var node = this;
      //name save
      node.name = $("#module-in-node-name").val();

      //description save
      $("#node-input-info").val(this.editor.getValue());

      this.editor.destroy();
      delete node.editor;
    },
    oneditcancle: function () {
      this.editor.destroy();
      delete this.editor;
    }
  });
</script>

<script type="text/javascript">
  RED.nodes.registerType("module_out", {
    category: "GBL-SASM-Alert",
    color: "#1E90FF",
    defaults: {
      name: { value: "module out" }
    },
    inputs: 1,
    outputs: 0,
    icon: function () {
      return "moduleflows_white.png";
    },
    label: function () {
      return this.name || "module out";
    },
    //open editor box
    oneditprepare: function () {
      //###0. init value
      $("#module-out-node-name").val(this.name);
    },
    oneditsave: function () {
      var node = this;
      //name save
      node.name = $("#module-out-node-name").val();

      this.editor.destroy();
      delete node.editor;
    },
    oneditcancle: function () {
      this.editor.destroy();
      delete this.editor;
    }
  });
</script>

<script type="text/html" data-template-name="moduleflows">
  <div class="form-row">
    <label for="moduleflows-node-name"><i class="icon-tag"></i> Name</label>
    <input type="text" id="moduleflows-node-name" placeholder="Name" />
  </div>
  <!--module-->
  <div>
    <div class="form-row">
      <label for="node-input-scope">
        <i class="fa fa-random"></i>
        <span>Module</span></label
      >
      <select id="module-select"></select>
    </div>
    <div id="module-description" class="description-box"></div>
  </div>
  <!--submodule-->
  <div id="submodule">
    <!-- <div class="form-row">
      <label for="node-input-scope">
        <i class="fa fa-random"></i> <span>SubModule</span>
      </label>
      <select id="submodule-select"></select>
    </div>
    <div id="submodule-description" class="description-box"></div> -->
  </div>
  <hr width="100%" color="black" size="4" />
  <!--module property-->
  <div id="property-input">
    <div class="form-row">
    </div>
  </div>
</script>

<script type="text/html" data-template-name="GBL_module_in">
  <div class="form-row" id="actionflows-name">
    <label for="module-in-node-name" id="node-name-label"
      ><i class="icon-tag"></i> Name</label
    >
    <div id="node-name-input-box">
      <input type="text" id="module-in-node-name" placeholder="Name" />
      <div id="module-in-node-error-box" class="error-box"></div>
    </div>
  </div>

  <!-- module in : module description -->
  <!-- markdown options -->
  <div class="form-row" style="margin-bottom: 0px;">
    <label for="node-input-info">Description</label>
    <a
      href="https://guides.github.com/features/mastering-markdown/"
      target="_blank"
      style="font-size: 0.8em; float: right;"
      >markdown</a
    >
    <input type="hidden" id="node-input-info" autofocus="autofocus" />
  </div>
  <!-- editor box -->
  <div class="form-row node-text-editor-row">
    <div
      style="height: 250px; min-height:150px;"
      class="node-text-editor"
      id="node-description-editor"
    ></div>
  </div>
</script>

<script type="text/html" data-template-name="module_out">
  <div class="form-row" id="actionflows-name">
    <label for="module-out-node-name"><i class="icon-tag"></i> Name</label>
    <input type="text" id="module-out-node-name" placeholder="Name" />
  </div>
</script>

<script type="text/html" data-help-name="moduleflows">
  <div>
    <p>module descrption text</p>
  </div>
</script>
<script type="text/html" data-help-name="GBL_module_in">
  <div>
    <p>module_in descrption text</p>
  </div>
</script>
<script type="text/html" data-help-name="module_out">
  <div>
    <p>module_out descrption text</p>
  </div>
</script>
