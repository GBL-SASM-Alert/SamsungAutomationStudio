<script src="socket.io/socket.io.js"></script>

<script>
  // TODO : import from common.js
  const EDITOR_SOCKET_TYPE = {
    FLOW_DEPLOYED: "flow-deployed",
  };
</script>

<script type="text/javascript">
  var socket = io();
  let dashboardConfigNode;

  function initializeDashboardConfig() {
    RED.events.on("deploy", function () {
      // const dashboardState = {
      //   tabs: [],
      // };

      // // update tab state
      // RED.nodes.eachConfig(node => {
      //   if (node.type == "soop_tab") dashboardState.tabs.push(node);
      // });

      // // update group state
      // RED.nodes.eachConfig(node => {
      //   for (tab in dashboardState.tabs) {
      //     if (tab.id == node.tabId) {
      //       if (Array.isArray(tab.groups)) {
      //         tab.groups.push(node);
      //       } else {
      //         tab.groups = [node];
      //       }
      //       break;
      //     }
      //   }
      // });

      // // update node state
      // RED.nodes.eachNode(node => {
      //   if (node.type.indexOf("soop") !== -1) {
      //     for (tab in dashboardState.tabs) {
      //       for (group in tab.groups) {
      //         if (group.id == node.groupId) {
      //           if (Array.isArray(group.nodes)) {
      //             group.nodes.push(node);
      //           } else {
      //             group.nodes = [node];
      //           }
      //         }
      //       }
      //     }
      //   }
      // });

      // dashboardConfigNode = createDashboardConfigNode();
      // socket.emit(EDITOR_SOCKET_TYPE.FLOW_DEPLOYED, dashboardState);

      const dashboardNodes = [];
      RED.nodes.eachNode(node => {
        if (node.type.indexOf("soop") !== -1) {
          dashboardNodes.push(node);
        }
      });

      dashboardConfigNode = createDashboardConfigNode();
      socket.emit(EDITOR_SOCKET_TYPE.FLOW_DEPLOYED, dashboardNodes);
    });
  }

  function createDashboardConfigNode() {
    const configNodes = [];
    RED.nodes.eachConfig(node => {
      if (node.type === "soop_dashboard_config") {
        configNodes.push(node);
      }
    });

    for (let i = 1; i < configNodes.length; ++i) {
      RED.nodes.remove(configNodes[i].id);
    }
    RED.nodes.dirty(true);

    let dashboardConfgNode = configNodes[0];
    if (!dashboardConfgNode) {
      dashboardConfgNode = {
        id: RED.nodes.id(),
        _def: RED.nodes.getType("soop_dashboard_config"),
        type: "soop_dashboard_config",
        users: [],
      };
    }
    RED.nodes.add(dashboardConfgNode);

    return dashboardConfgNode;
  }
</script>

<script type="text/javascript">
  RED.nodes.registerType("soop_dashboard_config", {
    category: "config",
    defaults: {
      name: {},
    },
    hasUsers: false,
    label: function () {
      return this.name || "Soop Dashboard Config";
    },
    onpaletteadd: initializeDashboardConfig,
  });
</script>

<script type="text/html" data-template-name="soop_dashboard_config">
  <div>This is configuration node for soop dashboard.</div>
</script>
